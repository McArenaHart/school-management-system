{% extends "base.html" %}
{% load static %}
{% block title %}Analytics Dashboard · SMS{% endblock %}

{% block hero %}
  <section class="hero-panel hero-strip">
    <article class="hero-card">
      <div class="icon">??</div>
      <div class="label">Students</div>
      <div class="value">{{ students_total }}</div>
      <div class="text-muted small mt-1">Active: {{ students_active }}</div>
    </article>
    <article class="hero-card">
      <div class="icon">??</div>
      <div class="label">Admissions</div>
      <div class="value">{{ admissions_new }}</div>
      <div class="text-muted small mt-1">Reviewed {{ admissions_reviewed }} ? Accepted {{ admissions_accepted }}</div>
    </article>
    <article class="hero-card">
      <div class="icon">?</div>
      <div class="label">Attendance</div>
      <div class="value">{{ att_total }}</div>
      <div class="text-muted small mt-1">
        <span class="badge-soft text-muted">P {{ att_present }}</span>
        <span class="badge-soft text-muted ms-1">L {{ att_late }}</span>
        <span class="badge-soft text-muted ms-1">A {{ att_absent }}</span>
      </div>
    </article>
    <article class="hero-card">
      <div class="icon">??</div>
      <div class="label">Fees balance</div>
      <div class="value">{{ balance }}</div>
      <div class="text-muted small mt-1">Invoiced {{ invoiced_sum }} ? Paid {{ paid_sum }}</div>
    </article>
  </section>
{% endblock %}

{% block content %}

  <div class="mb-4">
    <h3 class="mb-1">Analytics Dashboard</h3>
    <p class="text-muted mb-0">Overview of the last 30 days ({{ last_30 }} – {{ today }}).</p>
  </div>

  <div class="dashboard-grid mb-4">
    <div class="dashboard-panel">
      <div class="panel-header">
        <span>Fees status</span>
        <span class="pill">Invoices {{ inv_total }}</span>
      </div>
      <canvas id="feesChart" height="180"></canvas>
    </div>
    <div class="dashboard-panel">
      <div class="panel-header">
        <span>Attendance mix</span>
        <span class="pill">Last 30 days</span>
      </div>
      <canvas id="attChart" height="180"></canvas>
    </div>
    <div class="dashboard-panel">
      <div class="panel-header">
        <span>Admissions pipeline</span>
        <span class="pill">Count</span>
      </div>
      <canvas id="admChart" height="180"></canvas>
    </div>
  </div>

  <div class="dashboard-grid mb-4">
    <div class="dashboard-panel">
      <div class="panel-header">
        <span>Recent applications</span>
        <span class="pill">Pipeline</span>
      </div>
      <div class="table-responsive">
        <table class="table-cozy align-middle mb-0">
          <thead>
            <tr><th>Created</th><th>Applicant</th><th>Status</th><th class="text-end">Open</th></tr>
          </thead>
          <tbody>
            {% for a in recent_apps %}
              <tr>
                <td class="text-muted">{{ a.created_at }}</td>
                <td class="fw-semibold">{{ a.last_name }}, {{ a.first_name }}</td>
                <td><span class="badge text-bg-light">{{ a.status }}</span></td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'registrar:application_detail' a.id %}">View</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted p-3">
                  <div class="placeholder-panel">
                    <span class="placeholder-bar"></span>
                    <span class="placeholder-bar short"></span>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="dashboard-panel">
      <div class="panel-header">
        <span>Recent invoices</span>
        <span class="pill">Billing</span>
      </div>
      <div class="table-responsive">
        <table class="table-cozy align-middle mb-0">
          <thead>
            <tr>
              <th>Issue</th>
              <th>Invoice</th>
              <th>Student</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in recent_invoices %}
              <tr>
                <td class="text-muted">{{ inv.issue_date }}</td>
                <td class="fw-semibold">#{{ inv.id }}</td>
                <td>{{ inv.student.student_id|default:inv.student.student_number|default:"-" }}</td>
                <td><span class="badge text-bg-light">{{ inv.status }}</span></td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted p-3">
                  <div class="placeholder-panel">
                    <span class="placeholder-bar"></span>
                    <span class="placeholder-bar short"></span>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="dashboard-panel">
    <div class="panel-header">
      <span>Recent absences</span>
      <span class="pill">Attendance</span>
    </div>
    <div class="table-responsive">
      <table class="table-cozy align-middle mb-0">
        <thead>
          <tr><th>Date</th><th>Student</th><th>Class</th></tr>
        </thead>
        <tbody>
          {% for r in recent_absences %}
            <tr>
              <td class="text-muted">{{ r.date }}</td>
              <td class="fw-semibold">{{ r.student.student_id|default:r.student.student_number|default:"-" }}</td>
              <td>{{ r.class_group }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="3" class="text-center text-muted p-3">
                <div class="placeholder-panel">
                  <span class="placeholder-bar"></span>
                  <span class="placeholder-bar short"></span>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'assets/vendor/js/chart.umd.min.js' %}"></script>
  <script>
    const feesCtx = document.getElementById("feesChart");
    const attCtx = document.getElementById("attChart");
    const admCtx = document.getElementById("admChart");

    new Chart(feesCtx, {
      type: "doughnut",
      data: {
        labels: ["Paid", "Pending", "Partial", "Unpaid"],
        datasets: [{
          data: [
            Number("{{ inv_paid|default:0 }}"),
            Number("{{ inv_pending|default:0 }}"),
            Number("{{ inv_partial|default:0 }}"),
            Number("{{ inv_unpaid|default:0 }}"),
          ],
          backgroundColor: ["#4caf50", "#ffb703", "#00b4d8", "#f44336"],
          borderWidth: 0,
        }]
      },
      options: {
        plugins: { legend: { position: "bottom" } },
        cutout: "60%",
      }
    });

    new Chart(attCtx, {
      type: "doughnut",
      data: {
        labels: ["Present", "Late", "Absent"],
        datasets: [{
          data: [
            Number("{{ att_present|default:0 }}"),
            Number("{{ att_late|default:0 }}"),
            Number("{{ att_absent|default:0 }}"),
          ],
          backgroundColor: ["#0d6efd", "#ffc107", "#e53935"],
          borderWidth: 0,
        }]
      },
      options: {
        plugins: { legend: { position: "bottom" } },
        cutout: "55%",
      }
    });

    new Chart(admCtx, {
      type: "bar",
      data: {
        labels: ["New", "Reviewed", "Accepted"],
        datasets: [{
          label: "Applications",
          data: [
            Number("{{ admissions_new|default:0 }}"),
            Number("{{ admissions_reviewed|default:0 }}"),
            Number("{{ admissions_accepted|default:0 }}"),
          ],
          backgroundColor: "#0d6efd"
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  </script>
{% endblock %}
